<div class="app-shell">
  <mat-toolbar color="primary" class="app-toolbar mat-elevation-z4">
    <div class="brand">
      <span class="app-title">RideShare Connect</span>
      <span class="app-tagline">Smarter shared journeys</span>
    </div>
    <span class="toolbar-spacer"></span>
    <ng-container *ngIf="auth.isAuthenticated(); else loginActions">
      <div class="user-actions" *ngIf="user$ | async as user; else loadingUser">
        <div class="user-avatar" *ngIf="user?.photo">
          <img [src]="user.photo" alt="{{ user.name || 'User photo' }}" />
        </div>
        <div class="user-meta">
          <span class="user-name">{{ user?.name || 'Traveler' }}</span>
          <span class="user-email" *ngIf="user?.email">{{ user.email }}</span>
        </div>
        <button mat-stroked-button color="accent" type="button" (click)="handleLogout()">
          Logout
        </button>
      </div>
      <ng-template #loadingUser>
        <div class="user-actions">
          <span class="subtle">Loading profile...</span>
          <button mat-stroked-button color="accent" type="button" (click)="handleLogout()">
            Logout
          </button>
        </div>
      </ng-template>
    </ng-container>
    <ng-template #loginActions>
      <button mat-raised-button color="accent" type="button" (click)="auth.loginWithGoogle()">
        Login with Google
      </button>
    </ng-template>
  </mat-toolbar>

  <main class="content">
    <section class="hero">
      <div class="hero-copy">
        <p class="hero-kicker">Commute together</p>
        <h1 class="hero-title">Make every ride smarter</h1>
        <p class="hero-body">
          Coordinate safe, reliable carpools with colleagues and neighbours. Discover available rides or share your own in just a few clicks.
        </p>
        <div class="hero-actions">
          <button mat-raised-button color="primary" type="button" routerLink="/offer">
            Offer a ride
          </button>
          <button mat-stroked-button color="accent" type="button" (click)="scrollToResults()">
            Browse rides
          </button>
        </div>
      </div>
      <div class="hero-visual">
        <div class="hero-card mat-elevation-z4">
          <div class="hero-card-header">
            <span class="hero-card-title">Why RideShare Connect?</span>
          </div>
          <ul class="hero-card-list">
            <li>Verified Google profiles keep journeys safe</li>
            <li>Instant seat requests with real-time updates</li>
            <li>Smart reminders so no one misses a pickup</li>
          </ul>
        </div>
      </div>
    </section>

    <section class="search-section">
      <mat-card class="search-card mat-elevation-z2">
        <mat-card-header>
          <mat-card-title>Find a ride</mat-card-title>
          <mat-card-subtitle>Search by route or date to match a driver</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <form class="search-form" (ngSubmit)="search()">
            <div class="search-grid">
              <mat-form-field appearance="outline">
                <mat-label>From</mat-label>
                <input matInput [(ngModel)]="from" name="from" placeholder="Leaving from" />
              </mat-form-field>
              <mat-form-field appearance="outline">
                <mat-label>To</mat-label>
                <input matInput [(ngModel)]="to" name="to" placeholder="Going to" />
              </mat-form-field>
              <mat-form-field appearance="outline">
                <mat-label>Date</mat-label>
                <input matInput [(ngModel)]="date" name="date" type="date" [min]="minSearchDate" />
              </mat-form-field>
            </div>
            <div class="search-actions">
              <button mat-raised-button color="primary" type="submit">
                Search
              </button>
            </div>
          </form>
        </mat-card-content>
      </mat-card>
    </section>

    <section class="results-section" id="available-rides">
      <mat-card class="results-card mat-elevation-z1">
        <mat-card-header>
          <mat-card-title>Available rides</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <ng-container *ngIf="rides.length; else noRides">
            <div class="rides-grid">
              <mat-card class="ride-card mat-elevation-z1" *ngFor="let r of rides">
                <mat-card-header>
                  <mat-card-title>{{ r.from }} &rarr; {{ r.to }}</mat-card-title>
                  <mat-card-subtitle>{{ r.date | date: 'medium' }}</mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                  <div class="ride-meta">
                    <mat-chip-set aria-label="Ride summary" class="meta-chip-set">
                      <mat-chip color="primary" selected>{{ r.seats }} seats</mat-chip>
                      <mat-chip class="badge-chip" [ngClass]="{ low: r.remainingSeats <= 1 }">
                        {{ r.remainingSeats }} available
                      </mat-chip>
                      <mat-chip color="accent" selected>
                        ${{ r.price }}
                      </mat-chip>
                    </mat-chip-set>
                  </div>
                  <div class="ride-driver subtle">
                    Driver: {{ r.driver?.name || 'Unknown driver' }}
                  </div>
                </mat-card-content>
                <mat-divider></mat-divider>
                <mat-card-actions *ngIf="auth.isAuthenticated(); else loginPrompt" align="end" class="ride-actions">
                  <button
                    mat-raised-button
                    color="primary"
                    type="button"
                    (click)="requestSeat(r)"
                    [disabled]="shouldDisablePassengerRequest(r)"
                  >
                    {{ getPassengerRequestButtonLabel(r) }}
                  </button>
                  <span
                    class="inline-feedback"
                    [class.success]="requestStatus[r._id] === 'success' && !r.myRequest"
                    [class.error]="requestStatus[r._id] === 'error'"
                    *ngIf="requestMessage[r._id]"
                  >
                    {{ requestMessage[r._id] }}
                  </span>
                  <div class="status-wrapper" *ngIf="r.myRequest">
                    <mat-chip class="badge-chip" [ngClass]="r.myRequest.status">
                      {{ passengerStatusLabels[r.myRequest.status] }}
                    </mat-chip>
                    <span class="status-text">
                      {{ passengerStatusMessages[r.myRequest.status] }}
                    </span>
                  </div>
                </mat-card-actions>
                <ng-template #loginPrompt>
                  <div class="login-prompt subtle">Login to request a seat.</div>
                </ng-template>
                <div
                  class="conversation-container"
                  *ngIf="canShowPassengerConversation(r)"
                >
                  <button
                    mat-stroked-button
                    color="accent"
                    type="button"
                    class="conversation-toggle"
                    (click)="toggleConversation(r._id)"
                  >
                    {{ isConversationOpen(r._id) ? 'Hide conversation' : 'Open conversation' }}
                  </button>
                  <div *ngIf="isConversationOpen(r._id)" class="conversation">
                    <div class="conversation-loading" *ngIf="messagesLoading[r._id]">
                      Loading messages...
                    </div>
                    <div class="conversation-error" *ngIf="messagesError[r._id]">
                      {{ messagesError[r._id] }}
                      <button
                        mat-stroked-button
                        color="primary"
                        type="button"
                        class="conversation-refresh"
                        (click)="refreshConversation(r._id)"
                        [disabled]="messagesLoading[r._id]"
                      >
                        {{ messagesLoading[r._id] ? 'Refreshing...' : 'Retry' }}
                      </button>
                    </div>
                    <div
                      *ngIf="!messagesLoading[r._id] && !messagesError[r._id]"
                      class="conversation-feed"
                    >
                      <div
                        *ngIf="!rideMessages[r._id] || rideMessages[r._id].length === 0"
                        class="conversation-empty"
                      >
                        Start coordinating with your driver.
                      </div>
                      <div
                        *ngFor="let message of rideMessages[r._id]; trackBy: trackMessage"
                        class="conversation-message"
                        [ngClass]="{ mine: message.isMine }"
                      >
                        <div class="conversation-meta">
                          <span>{{ message.sender?.name || 'Rider' }}</span>
                          <span>- {{ message.createdAt | date: 'short' }}</span>
                        </div>
                        <div class="conversation-body">{{ message.body }}</div>
                      </div>
                    </div>
                    <div class="conversation-input">
                      <textarea
                        [(ngModel)]="messageDraft[r._id]"
                        name="messagePassenger-{{ r._id }}"
                        placeholder="Share pickup details or ask a question"
                      ></textarea>
                      <div class="conversation-actions">
                        <button
                          mat-raised-button
                          color="primary"
                          type="button"
                          (click)="sendMessage(r._id)"
                          [disabled]="messageSendStatus[r._id] === 'loading'"
                        >
                          {{ messageSendStatus[r._id] === 'loading' ? 'Sending...' : 'Send message' }}
                        </button>
                        <button
                          mat-stroked-button
                          type="button"
                          color="accent"
                          (click)="refreshConversation(r._id)"
                          [disabled]="messagesLoading[r._id]"
                        >
                          {{ messagesLoading[r._id] ? 'Refreshing...' : 'Refresh' }}
                        </button>
                        <span
                          class="conversation-error"
                          *ngIf="messageSendStatus[r._id] === 'error' && messageSendMessage[r._id]"
                        >
                          {{ messageSendMessage[r._id] }}
                        </span>
                        <span
                          class="inline-feedback success"
                          *ngIf="messageSendStatus[r._id] === 'success'"
                        >
                          Sent
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </mat-card>
            </div>
          </ng-container>
          <ng-template #noRides>
            <div class="empty-state">No rides match your search yet. Try broadening your filters.</div>
          </ng-template>
        </mat-card-content>
      </mat-card>
    </section>

    <section class="driver-section" *ngIf="auth.isAuthenticated()">
      <mat-card class="driver-card mat-elevation-z1">
        <mat-card-header>
          <mat-card-title>Your driver hub</mat-card-title>
          <mat-card-subtitle>Manage ride requests and keep travellers updated</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="driver-actions">
            <button mat-stroked-button color="primary" type="button" (click)="loadMyRides()" [disabled]="myRidesLoading">
              {{ myRidesLoading ? 'Refreshing...' : 'Refresh' }}
            </button>
          </div>
          <div *ngIf="myRidesError" class="driver-error">
            {{ myRidesError }}
          </div>
          <div *ngIf="myRidesLoading" class="subtle">Loading...</div>
          <div *ngIf="!myRidesLoading && !myRidesError && myRides.length === 0" class="empty-state">
            No seat requests yet.
          </div>
          <div class="driver-rides" *ngIf="myRides.length">
            <mat-card class="driver-ride-card mat-elevation-z1" *ngFor="let ride of myRides">
              <mat-card-header>
                <mat-card-title>{{ ride.from }} &rarr; {{ ride.to }}</mat-card-title>
                <mat-card-subtitle>{{ ride.date | date: 'medium' }}</mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
                <div class="ride-meta">
                  <mat-chip-set aria-label="Driver ride summary" class="meta-chip-set">
                    <mat-chip color="primary" selected>Seats {{ ride.seats }}</mat-chip>
                    <mat-chip class="badge-chip" [ngClass]="{ low: ride.remainingSeats <= 1 }">
                      {{ ride.remainingSeats }} remaining
                    </mat-chip>
                    <mat-chip color="accent" selected>
                      ${{ ride.price }}
                    </mat-chip>
                  </mat-chip-set>
                </div>
                <div *ngIf="ride.requests.length === 0" class="empty-state">
                  No requests for this ride yet.
                </div>
                <div class="request-list" *ngIf="ride.requests.length">
                  <div class="request-item" *ngFor="let req of ride.requests">
                    <div class="request-header">
                      <div>
                        <div class="request-name">{{ req.passenger?.name || 'Passenger' }}</div>
                        <div class="subtle" *ngIf="req.passenger?.email">{{ req.passenger?.email }}</div>
                      </div>
                      <mat-chip class="badge-chip" [ngClass]="req.status">
                        {{ req.status }}
                      </mat-chip>
                    </div>
                    <div class="subtle">Seats requested: {{ req.seats }}</div>
                    <div *ngIf="req.message" class="request-message">Message: {{ req.message }}</div>
                    <div class="driver-controls">
                      <ng-container *ngIf="req.status === 'pending'; else resolvedTpl">
                        <button
                          mat-raised-button
                          color="primary"
                          type="button"
                          (click)="updateRequestStatus(ride, req, 'approved')"
                          [disabled]="requestActionStatus[req.key] === 'loading'"
                        >
                          {{ requestActionStatus[req.key] === 'loading' ? 'Saving...' : 'Approve' }}
                        </button>
                        <button
                          mat-stroked-button
                          color="warn"
                          type="button"
                          (click)="updateRequestStatus(ride, req, 'rejected')"
                          [disabled]="requestActionStatus[req.key] === 'loading'"
                        >
                          Reject
                        </button>
                      </ng-container>
                      <ng-template #resolvedTpl>
                        <span class="resolved-label">Request {{ req.status }}</span>
                      </ng-template>
                      <span
                        class="inline-feedback"
                        [class.success]="requestActionStatus[req.key] === 'success'"
                        [class.error]="requestActionStatus[req.key] === 'error'"
                        *ngIf="requestActionMessage[req.key]"
                      >
                        {{ requestActionMessage[req.key] }}
                      </span>
                    </div>
                  </div>
                </div>
              <div
                class="conversation-container"
                *ngIf="canShowDriverConversation(ride)"
              >
                <button
                  mat-stroked-button
                  color="accent"
                  type="button"
                  class="conversation-toggle"
                  (click)="toggleConversation(ride._id)"
                >
                  {{ isConversationOpen(ride._id) ? 'Hide conversation' : 'Open conversation' }}
                </button>
                <div *ngIf="isConversationOpen(ride._id)" class="conversation">
                  <div class="conversation-loading" *ngIf="messagesLoading[ride._id]">
                    Loading messages...
                  </div>
                  <div class="conversation-error" *ngIf="messagesError[ride._id]">
                    {{ messagesError[ride._id] }}
                    <button
                      mat-stroked-button
                      color="primary"
                      type="button"
                      class="conversation-refresh"
                      (click)="refreshConversation(ride._id)"
                      [disabled]="messagesLoading[ride._id]"
                    >
                      {{ messagesLoading[ride._id] ? 'Refreshing...' : 'Retry' }}
                    </button>
                  </div>
                  <div
                    *ngIf="!messagesLoading[ride._id] && !messagesError[ride._id]"
                    class="conversation-feed"
                  >
                    <div
                      *ngIf="!rideMessages[ride._id] || rideMessages[ride._id].length === 0"
                      class="conversation-empty"
                    >
                      Share pick-up details with your passengers.
                    </div>
                    <div
                      *ngFor="let message of rideMessages[ride._id]; trackBy: trackMessage"
                      class="conversation-message"
                      [ngClass]="{ mine: message.isMine }"
                    >
                      <div class="conversation-meta">
                        <span>{{ message.sender?.name || 'Rider' }}</span>
                        <span>- {{ message.createdAt | date: 'short' }}</span>
                      </div>
                      <div class="conversation-body">{{ message.body }}</div>
                    </div>
                  </div>
                  <div class="conversation-input">
                    <textarea
                      [(ngModel)]="messageDraft[ride._id]"
                      name="messageDriver-{{ ride._id }}"
                      placeholder="Share meeting points or updates"
                    ></textarea>
                    <div class="conversation-actions">
                      <button
                        mat-raised-button
                        color="primary"
                        type="button"
                        (click)="sendMessage(ride._id)"
                        [disabled]="messageSendStatus[ride._id] === 'loading'"
                      >
                        {{ messageSendStatus[ride._id] === 'loading' ? 'Sending...' : 'Send message' }}
                      </button>
                      <button
                        mat-stroked-button
                        type="button"
                        color="accent"
                        (click)="refreshConversation(ride._id)"
                        [disabled]="messagesLoading[ride._id]"
                      >
                        {{ messagesLoading[ride._id] ? 'Refreshing...' : 'Refresh' }}
                      </button>
                      <span
                        class="conversation-error"
                        *ngIf="messageSendStatus[ride._id] === 'error' && messageSendMessage[ride._id]"
                      >
                        {{ messageSendMessage[ride._id] }}
                      </span>
                      <span
                        class="inline-feedback success"
                        *ngIf="messageSendStatus[ride._id] === 'success'"
                      >
                        Sent
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              </mat-card-content>
              <mat-card-actions class="driver-ride-actions">
                <button
                  mat-stroked-button
                  color="warn"
                  type="button"
                  (click)="removeRide(ride)"
                  [disabled]="removalStatus[ride._id] === 'loading'"
                >
                  {{ removalStatus[ride._id] === 'loading' ? 'Removing...' : 'Remove ride' }}
                </button>
                <span
                  class="inline-feedback"
                  [class.success]="removalStatus[ride._id] === 'success'"
                  [class.error]="removalStatus[ride._id] === 'error'"
                  *ngIf="removalMessage[ride._id]"
                >
                  {{ removalMessage[ride._id] }}
                </span>
              </mat-card-actions>
            </mat-card>
          </div>
        </mat-card-content>
      </mat-card>
    </section>
  </main>
</div>













